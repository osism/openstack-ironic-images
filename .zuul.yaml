---
- secret:
    name: SECRET_OPENSTACK_IRONIC_IMAGES
    data:
      S3_ACCESS_KEY: !encrypted/pkcs1-oaep
        - lCrjjw0PGgYdGd6bhvt8QAIZwOGqrGqQqxNrCLw5QrfcpsMVVibKkqSp35xmorMOJbvQ3
          jWKAJpqfQNL+UEE/e5WZwfe7pRGKDx3u2fKdCkGexSC2Q2vKCKEL6D20OPW7ELsOoh+Si
          8V0UaLqNnROUrbZZlzZcyQ7yUJNscYTcZcQ/DQJZjNLS/nnZWTThizV5+mzYDtVBdmrhn
          /Tkp9IdF+wv2oP5XgBGth6Ja9ANeXHaarPvS7llqHjqRKzJNj8lgwvh2Boe9PsJk4jHp4
          f1v+VgWjiYIaIKSwDRbqzcydVc4A4zQpaeCYk4BkFSvuHNh/xvTIs+I22+GZ7/RX67srh
          T32MFxWIj8xlLCvwlo4+KdQPekIi6lBYKtIptsDt3uXfk7Smbb3574Ko3qkw9gtaPnDsc
          B4byeUTfQxWMeDB6duGO7qS90sxe1JJ6DopDjtV5FZ04v7TvZTXu+6o8OY0u4wT7nHdVZ
          t+aq7j3Wlb5TOrUf7LeEmYQ0jYW898zKnnAYHhPy8w3IYX4DKEZQB1EyCCsTSJLCrVqkJ
          bdvG5/88EUWd3PCQ16YsKC7CzDd+TzWe99oYFSSJ91Km9pItIH3y8SkZLkgTPT91Mf8BK
          ioa8WKFwrBGwJyfFDCQDQ2grieUzfgV1pc3SMcutbKqylM4vsO6h6feIp+eJKQ=
      S3_SECRET_KEY: !encrypted/pkcs1-oaep
        - SwQdIWGnwIBDIn6Xvmt7xsKXx7/qiNuFNqb61p5mFAQOzKdJO3voMRBM40lX9oawgclsh
          pcLfQtsYBVkU3XoacoChsEKgmJ/qqHLJghwzPeBpVMakwyPx7DQDYEWaEYziUgMeGmlEc
          Jgsj3GCFqWZnRbdMob6WEAVWpzsFteS3PvNnSoLveUnN44rLdjrRllmpAp/7hq+TABtgg
          W/HL5Sd/sFWNmHgPJ4JE2HOY2OZzHhRmq9j0cHcW9EetqDJrhz68dScubRztOa4miRWuu
          EOLv0OfylN8eRtb2KVbu7Jq8kWUeik5j3dVz5p6yw8sXC12G7d8wwiTWK0/k2ZX1EfYgT
          AA04d7tXdv9lSr7rh3bTyPJf+mqLmcf3nKnqqMlbRg95WALdV0UM/S6Rcluw3x6951bOH
          yG2RXqMnGgkL6YnyGjMMjcTbNE1QdDKWAWYXwupISj2voiZ+n0q8O0GalO1BrOYO45iGi
          rll+7axNxwbROCA/NEtPNKtDMf9ZdlDswc3vgOlxnlJMv62C+bceMO5d7jmFR7aYnXtbi
          dTSIexlbF1ocv8d0DrBTu2/dNbUbhFt4copis5bTi/F/fTPAazDPj0V5uccoBDVAk27u4
          ox/mFD+gn1Ij3Is+hsTabVLzCHR8cSJTcHWcN/506aiavuO19lLdAgwx/UxZ8A=

- semaphore:
    name: semaphore-openstack-ironic-images-publish-burnin
    max: 1

- semaphore:
    name: semaphore-openstack-ironic-images-publish-metalbox
    max: 1

- semaphore:
    name: semaphore-openstack-ironic-images-publish-osism-ipa
    max: 1

- semaphore:
    name: semaphore-openstack-ironic-images-publish-osism-ipa-stable
    max: 1

- semaphore:
    name: semaphore-openstack-ironic-images-publish-osism-node
    max: 1

- semaphore:
    name: semaphore-openstack-ironic-images-publish-osism-esp
    max: 1

- semaphore:
    name: semaphore-openstack-ironic-images-publish-osism-vyos
    max: 1

- job:
    name: abstract-openstack-ironic-images-build
    abstract: true
    nodeset: ubuntu-noble-large
    pre-run: playbooks/pre.yml
    run: playbooks/build.yml
    timeout: 7200
    vars:
      upload_image: false

- job:
    name: abstract-openstack-ironic-images-publish
    parent: abstract-openstack-ironic-images-build
    vars:
      upload_image: true

- job:
    name: openstack-ironic-images-build-burnin
    parent: abstract-openstack-ironic-images-build
    vars:
      dib_element: burnin
      image_format: raw
    files:
      - "^elements/burnin/.*"
      - "^files/burnin.sh"
      - "^files/burnin/.*"
      - "^playbooks/.*"
      - "^requirements.txt"

- job:
    name: openstack-ironic-images-publish-burnin
    parent: abstract-openstack-ironic-images-publish
    semaphores:
      - name: semaphore-openstack-ironic-images-publish-burnin
    vars:
      dib_element: burnin
      image_format: raw
    secrets:
      - name: s3
        secret: SECRET_OPENSTACK_IRONIC_IMAGES
        pass-to-parent: true
    files:
      - "^elements/burnin/.*"
      - "^files/burnin.sh"
      - "^files/burnin/.*"
      - "^playbooks/.*"
      - "^requirements.txt"

- job:
    name: openstack-ironic-images-build-metalbox
    parent: abstract-openstack-ironic-images-build
    vars:
      dib_element: metalbox
      image_format: raw
    files:
      - "^elements/metalbox/.*"
      - "^files/metalbox.sh"
      - "^files/metalbox/.*"
      - "^playbooks/.*"
      - "^requirements.txt"

- job:
    name: openstack-ironic-images-publish-metalbox
    parent: abstract-openstack-ironic-images-publish
    semaphores:
      - name: semaphore-openstack-ironic-images-publish-metalbox
    vars:
      dib_element: metalbox
      image_format: raw
    secrets:
      - name: s3
        secret: SECRET_OPENSTACK_IRONIC_IMAGES
        pass-to-parent: true
    files:
      - "^elements/metalbox/.*"
      - "^files/metalbox.sh"
      - "^files/metalbox/.*"
      - "^playbooks/.*"
      - "^requirements.txt"

- job:
    name: openstack-ironic-images-build-osism-ipa
    parent: base-extra-logs
    nodeset:
      nodes:
        - label: ubuntu-noble-uefi
          name: noble
    pre-run: playbooks/pre.yml
    run: playbooks/builder.yml
    vars:
      build_name: osism-ipa
      upload_image: false
    files: &osism_ipa_files
      - "^elements/install-ansible/.*"
      - "^elements/osism-ipa/.*"
      - "^files/osism-ipa.yml$"
      - "^playbooks/.*"
      - "^requirements.txt"

- job:
    name: openstack-ironic-images-publish-osism-ipa
    parent: openstack-ironic-images-build-osism-ipa
    semaphores:
      - name: semaphore-openstack-ironic-images-publish-osism-ipa
    vars:
      build_name: osism-ipa
      image_format: initramfs
      upload_image: true
    secrets:
      - name: s3
        secret: SECRET_OPENSTACK_IRONIC_IMAGES
        pass-to-parent: true
    files: *osism_ipa_files

- job:
    name: openstack-ironic-images-build-osism-ipa-stable
    parent: base-extra-logs
    nodeset:
      nodes:
        - label: ubuntu-noble-uefi
          name: noble
    pre-run: playbooks/pre.yml
    run: playbooks/builder.yml
    vars:
      build_name: osism-ipa-stable
      upload_image: false
    files: &osism_ipa_stable_files
      - "^elements/install-ansible/.*"
      - "^elements/osism-ipa/.*"
      - "^files/osism-ipa-stable.yml$"
      - "^playbooks/.*"
      - "^requirements.txt"

- job:
    name: openstack-ironic-images-publish-osism-ipa-stable
    parent: openstack-ironic-images-build-osism-ipa-stable
    semaphores:
      - name: semaphore-openstack-ironic-images-publish-osism-ipa-stable
    vars:
      build_name: osism-ipa-stable
      image_format: initramfs
      upload_image: true
    secrets:
      - name: s3
        secret: SECRET_OPENSTACK_IRONIC_IMAGES
        pass-to-parent: true
    files: *osism_ipa_stable_files

- job:
    name: openstack-ironic-images-build-osism-node
    parent: base-extra-logs
    nodeset:
      nodes:
        - label: ubuntu-noble-uefi
          name: noble
    pre-run: playbooks/pre.yml
    run: playbooks/builder.yml
    vars:
      build_name: osism-node
      upload_image: false
    files: &osism_node_files
      - "^elements/ansible-init/.*"
      - "^elements/block-device-osism-efi/.*"
      - "^elements/install-ansible/.*"
      - "^elements/osism-node/.*"
      - "^files/osism-node.yml$"
      - "^playbooks/.*"
      - "^requirements.txt"

- job:
    name: openstack-ironic-images-publish-osism-node
    parent: openstack-ironic-images-build-osism-node
    semaphores:
      - name: semaphore-openstack-ironic-images-publish-osism-node
    vars:
      build_name: osism-node
      upload_image: true
    secrets:
      - name: s3
        secret: SECRET_OPENSTACK_IRONIC_IMAGES
        pass-to-parent: true
    files: *osism_node_files

- job:
    name: openstack-ironic-images-build-osism-esp
    parent: base-extra-logs
    nodeset:
      nodes:
        - label: ubuntu-noble-uefi
          name: noble
    pre-run: playbooks/pre.yml
    run: playbooks/builder.yml
    vars:
      build_name: osism-esp
      image_format: raw
      upload_image: false
    files: &osism_esp_files
      - "^elements/osism-esp/.*"
      - "^files/osism-esp.yml$"
      - "^playbooks/.*"
      - "^requirements.txt"

- job:
    name: openstack-ironic-images-publish-osism-esp
    parent: openstack-ironic-images-build-osism-esp
    semaphores:
      - name: semaphore-openstack-ironic-images-publish-osism-esp
    vars:
      build_name: osism-esp
      image_format: raw
      upload_image: true
    secrets:
      - name: s3
        secret: SECRET_OPENSTACK_IRONIC_IMAGES
        pass-to-parent: true
    files: *osism_esp_files

- job:
    name: openstack-ironic-images-build-osism-vyos
    parent: base-extra-logs
    nodeset:
      nodes:
        - label: ubuntu-noble-uefi
          name: noble
    pre-run: playbooks/pre.yml
    run: playbooks/builder.yml
    vars:
      build_name: osism-vyos
      upload_image: false
    files: &osism_vyos_files
      - "^elements/block-device-osism-efi/.*"
      - "^elements/osism-vyos/.*"
      - "^files/osism-vyos.yml$"
      - "^playbooks/.*"
      - "^requirements.txt"

- job:
    name: openstack-ironic-images-publish-osism-vyos
    parent: openstack-ironic-images-build-osism-vyos
    semaphores:
      - name: semaphore-openstack-ironic-images-publish-osism-vyos
    vars:
      build_name: osism-vyos
      upload_image: true
    secrets:
      - name: s3
        secret: SECRET_OPENSTACK_IRONIC_IMAGES
        pass-to-parent: true
    files: *osism_vyos_files

- project:
    merge-mode: squash-merge
    default-branch: main
    check:
      jobs:
        - openstack-ironic-images-build-burnin
        - openstack-ironic-images-build-metalbox
        - openstack-ironic-images-build-osism-ipa
        - openstack-ironic-images-build-osism-ipa-stable
        - openstack-ironic-images-build-osism-node
        - openstack-ironic-images-build-osism-esp
        - openstack-ironic-images-build-osism-vyos
        - yamllint
    periodic-daily:
      jobs:
        - openstack-ironic-images-publish-metalbox
        - yamllint
    periodic-weekly:
      jobs:
        - openstack-ironic-images-publish-burnin
        - openstack-ironic-images-publish-osism-esp
        - openstack-ironic-images-publish-osism-ipa
        - openstack-ironic-images-publish-osism-ipa-stable
        - openstack-ironic-images-publish-osism-node
    post:
      jobs:
        - openstack-ironic-images-publish-burnin:
            branches: main
        - openstack-ironic-images-publish-metalbox:
            branches: main
        - openstack-ironic-images-publish-osism-ipa:
            branches: main
        - openstack-ironic-images-publish-osism-ipa-stable:
            branches: main
        - openstack-ironic-images-publish-osism-node:
            branches: main
        - openstack-ironic-images-publish-osism-esp:
            branches: main
        - openstack-ironic-images-publish-osism-vyos:
            branches: main
